{% extends 'base.html' %}
{% load static %}

{% block content %}

	<!-- Start Banner Area -->
	<section class="banner-area organic-breadcrumb">
		<div class="container">
			<div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
				<div class="col-first">
					{% if 'search' in request.path %}
					<h1>Search results for "{{ request.GET.q }}"</h1>
					{% else %}
					<h1>Our Store</h1>
					{% endif %}
				</div>
			</div>
		</div>
	</section>
	<!-- End Banner Area -->
	<div class="container">
		<div class="row">
			<div class="col-xl-3 col-lg-4 col-md-5">
				<div class="sidebar-categories">
					<div class="head">Browse Categories</div>
					<ul class="main-categories">
						<li class="main-nav-list"><a href="{% url 'store'%}">All Products</a></li>
						{% for category in links %}
						<li class="main-nav-list"><a data-toggle="collapse"> <a href="{{category.get_url}}">{{category.category_name}}</a> </li>
						{% endfor %}
					</ul>
				</div>
				<div class="sidebar-filter mt-50">
					<div class="top-filter-head">Product Filters</div>
					<div class="common-filter">
						<form method="GET" id="price-filter-form">
							{% if request.GET.q %}
								<input type="hidden" name="q" value="{{ request.GET.q }}">
							{% endif %}
							<div class="head">Price Range</div>
							<div class="price-range-area">
								<div class="price-inputs d-flex">
									<div class="price-input">
										<label>Min Price:</label>
										<input type="number" name="min_price" value="{{ current_min_price }}"
											   placeholder="₦0" min="0" class="form-control">
									</div>
									<div class="price-input ml-3">
										<label>Max Price:</label>
										<input type="number" name="max_price" value="{{ current_max_price }}"
											   placeholder="₦999999" min="0" class="form-control">
									</div>
								</div>
								<div class="value-wrapper d-flex mt-3">
									<div class="price">Price Range:</div>
									<span>₦</span>
									<span id="min-display">{{ price_range.min_price|default:0 }}</span>
									<div class="to">to</div>
									<span>₦</span>
									<span id="max-display">{{ price_range.max_price|default:999999 }}</span>
								</div>
								<button type="submit" class="btn primary-btn mt-3 w-100">Apply Filter</button>
								<a href="{% url 'store' %}" class="btn btn-secondary mt-2 w-100">Clear Filter</a>
							</div>
						</form>
					</div>
				</div>
			</div>
			<div class="col-xl-9 col-lg-8 col-md-7">
				<!-- Start Filter Bar -->
				<div class="filter-bar d-flex flex-wrap align-items-center">
					<div class="sorting">
						<form method="GET" id="sort-form">
							{% if request.GET.q %}
								<input type="hidden" name="q" value="{{ request.GET.q }}">
							{% endif %}
							{% if request.GET.min_price %}
								<input type="hidden" name="min_price" value="{{ request.GET.min_price }}">
							{% endif %}
							{% if request.GET.max_price %}
								<input type="hidden" name="max_price" value="{{ request.GET.max_price }}">
							{% endif %}
							<select name="sort" onchange="this.form.submit()">
								<option value="default" {% if current_sort == 'default' %}selected{% endif %}>Default sorting</option>
								<option value="price_low" {% if current_sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
								<option value="price_high" {% if current_sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
								<option value="name_asc" {% if current_sort == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
								<option value="name_desc" {% if current_sort == 'name_desc' %}selected{% endif %}>Name: Z to A</option>
								<option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest First</option>
							</select>
						</form>
					</div>
					<div class="sorting-results ml-auto">
						<span>Showing {{ products.start_index }}-{{ products.end_index }} of {{ product_count }} results</span>
					</div>
				</div>
				<!-- End Filter Bar -->
				<!-- Start Best Seller -->
				<section class="lattest-product-area pb-40 category-list">
					<div class="row">
						{% if products %}
						<!-- single product -->
						{% for product in products %}
							<div class="col-lg-4 col-md-6">
								<div class="single-product">
									<img class="img-fluid" src="{{product.images.url}}" alt="{{ product.product_name}}">
									<div class="product-details">
										<h6>{{ product.product_name}}</h6>
										<div class="price">
											<h6>₦{{product.price}}</h6>
										</div>
										<div class="prd-bottom">

											<a href="#" class="social-info add-to-cart-btn" data-product-id="{{ product.id }}" data-product-name="{{ product.product_name }}">
												<span class="ti-bag"></span>
												<p class="hover-text">add to bag</p>
											</a>
											<a href="{{product.get_url}}" class="social-info">
												<span class="lnr lnr-move"></span>
												<p class="hover-text">view more</p>
											</a>
										</div>
									</div>
								</div>
							</div>
						{% endfor %}
						{% else %}
							<h3 class="text-center mt-5 mx-5">No products found.</h3>
						{% endif %}
					</div>
				</section>
				<!-- End Best Seller -->
				<!-- Start Filter Bar -->
				 {%if products.has_other_pages %}
				<div class="filter-bar d-flex flex-wrap align-items-center">
					<div class="pagination">
						{% if products.has_previous %}
						<a href="?page={{products.previous_page_number}}" class="prev-arrow"><i class="fa fa-long-arrow-left" aria-hidden="true"></i></a>
						{% endif %}
						{% for num in products.paginator.page_range %}
							{% if products.number == num %}
								<a href="?page={{num}}" class="active">{{num}}</a>
							{% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
								<a href="?page={{num}}">{{num}}</a>
							{% endif %}
						{% endfor %}
						{% if products.has_next %}
						<a href="?page={{products.next_page_number}}" class="next-arrow"><i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>
						{% endif %}
					</div>
				</div>
				{% endif %}
				<!-- End Filter Bar -->
			</div>
		</div>
	</div>
	<br>
	<br>
	<br>
	

	

	<!-- Modal Quick Product View -->
	<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="container relative">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<div class="product-quick-view">
					<div class="row align-items-center">
						<div class="col-lg-6">
							<div class="quick-view-carousel">
								<div class="item" style="background: url(img/organic-food/q1.jpg);">

								</div>
								<div class="item" style="background: url(img/organic-food/q1.jpg);">

								</div>
								<div class="item" style="background: url(img/organic-food/q1.jpg);">

								</div>
							</div>
						</div>
						<div class="col-lg-6">
							<div class="quick-view-content">
								<div class="top">
									<h3 class="head">Mill Oil 1000W Heater, White</h3>
									<div class="price d-flex align-items-center"><span class="lnr lnr-tag"></span> <span class="ml-10">₦149.99</span></div>
									<div class="category">Category: <span>Household</span></div>
									<div class="available">Availibility: <span>In Stock</span></div>
								</div>
								<div class="middle">
									<p class="content">Mill Oil is an innovative oil filled radiator with the most modern technology. If you are
										looking for something that can make your interior look awesome, and at the same time give you the pleasant
										warm feeling during the winter.</p>
									<a href="#" class="view-full">View full Details <span class="lnr lnr-arrow-right"></span></a>
								</div>
								<div class="bottom">
									<div class="color-picker d-flex align-items-center">Color:
										<span class="single-pick"></span>
										<span class="single-pick"></span>
										<span class="single-pick"></span>
										<span class="single-pick"></span>
										<span class="single-pick"></span>
									</div>
									<div class="quantity-container d-flex align-items-center mt-15">
										Quantity:
										<input type="text" class="quantity-amount ml-15" value="1" />
										<div class="arrow-btn d-inline-flex flex-column">
											<button class="increase arrow" type="button" title="Increase Quantity"><span class="lnr lnr-chevron-up"></span></button>
											<button class="decrease arrow" type="button" title="Decrease Quantity"><span class="lnr lnr-chevron-down"></span></button>
										</div>

									</div>
									<div class="d-flex mt-20">
										<a href="#" class="view-btn color-2"><span>Add to Cart</span></a>
										<a href="#" class="like-btn"><span class="lnr lnr-layers"></span></a>
										<a href="#" class="like-btn"><span class="lnr lnr-heart"></span></a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

<!-- Toast Notification -->
<div id="cart-toast" class="cart-toast">
    <div class="toast-content">
        <span class="toast-icon">✓</span>
        <span class="toast-message"></span>
    </div>
</div>

<!-- AJAX Cart Functionality -->
<style>
/* Toast Notification Styles */
.cart-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    transform: translateX(400px);
    transition: transform 0.3s ease-in-out;
    min-width: 300px;
}

.cart-toast.show {
    transform: translateX(0);
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toast-icon {
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.toast-message {
    flex: 1;
    font-weight: 500;
}

/* Loading state for add to cart button */
.add-to-cart-btn.loading {
    opacity: 0.7;
    pointer-events: none;
}

.add-to-cart-btn.loading .ti-bag:before {
    content: "\e627"; /* Loading icon */
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Success state */
.add-to-cart-btn.success .ti-bag:before {
    content: "✓";
    color: #28a745;
}

/* Price filter styling */
.price-inputs {
  gap: 15px;
}

.price-input {
  flex: 1;
}

.price-input label {
  font-size: 12px;
  font-weight: 500;
  color: #222;
  margin-bottom: 5px;
  display: block;
}

.price-input input {
  height: 35px;
  font-size: 14px;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 5px 10px;
}

.price-input input:focus {
  border-color: #ffba00;
  outline: none;
  box-shadow: 0 0 5px rgba(255, 186, 0, 0.3);
}

.value-wrapper {
  align-items: center;
  font-size: 14px;
  color: #777;
}

.value-wrapper .to {
  margin: 0 10px;
}

.sorting-results {
  font-size: 14px;
  color: #777;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Add to cart AJAX functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();

            const productId = this.getAttribute('data-product-id');
            const productName = this.getAttribute('data-product-name');
            const originalButton = this;

            // Add loading state
            originalButton.classList.add('loading');

            // AJAX request
            fetch(`/cart/add_cart_ajax/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                originalButton.classList.remove('loading');

                if (data.success) {
                    // Add success state
                    originalButton.classList.add('success');

                    // Update cart badge using global function
                    if (typeof updateCartBadge === 'function') {
                        updateCartBadge(data.cart_count);
                    } else {
                        // Fallback if global function not available
                        const cartBadge = document.querySelector('.cart-badge');
                        if (cartBadge) {
                            cartBadge.textContent = data.cart_count;
                            cartBadge.style.display = 'flex';
                        } else if (data.cart_count > 0) {
                            const cartIcon = document.querySelector('.cart-icon');
                            if (cartIcon) {
                                const badge = document.createElement('span');
                                badge.className = 'cart-badge';
                                badge.textContent = data.cart_count;
                                cartIcon.appendChild(badge);
                            }
                        }
                    }

                    // Show success toast
                    showToast(data.message, 'success');

                    // Remove success state after 2 seconds
                    setTimeout(() => {
                        originalButton.classList.remove('success');
                    }, 2000);

                } else {
                    showToast(data.message || 'Error adding item to cart', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                originalButton.classList.remove('loading');
                showToast('Error adding item to cart', 'error');
            });
        });
    });

    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.getElementById('cart-toast');
        const toastMessage = toast.querySelector('.toast-message');

        toastMessage.textContent = message;

        // Change color based on type
        if (type === 'error') {
            toast.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
        } else {
            toast.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
        }

        // Show toast
        toast.classList.add('show');

        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
});
</script>

{% endblock content %}

</body>

</html>